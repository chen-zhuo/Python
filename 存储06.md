## 操作MongoDB

同样，在执行下面操作时，确保电脑中安装了MongoDB，且将MongoDB的路径添加到了环境变量中。

### 启动MongoDB服务

在命令行窗口输入，启动MongoDB服务：

```
net start mongodb
```

### 安装pymongo

安装第三方库pymongo，用于连接数据库：

```
pip install pymongo
```

### 配置连接参数

```python
# 导入pymongo
from pymongo import MongoClient

# 连接本地的MongoDB数据库
client = MongoClient()
# 连接其他机器的MongoDB数据库
client = MongoClient('mongodb://主机IP:27017')
client = MongoClient(host='主机IP', port = 27017)
# 连接对象，假设要连接的数据库名为:primer
db = client.primer
db = client['primer']
# 操作游标，连接到对应的数据表
coll = db.dataset
coll = db['dataset']
```

### 插入数据

插入数据方法：

```python
# 插入数据
coll.insert(document)
# 插⼊一条数据
coll.insert_one(document)
# 插入多条数据
coll.insert_many(documents, ordered=True)
```

插入一条字典类型数据：

```python
# 插入数据 students 这个集合，新建一条学生数据，这条数据以字典形式表示：
student = { 'id':'20170101', 
            'name':'Jordan',
            'age', 20, 
            'gender':'male'}

# 执行插入数据方法
result = coll.insert(student) 
# 在MongoDB 中，每条数据都有一个＿id 属性来唯一标识。如果没有显式指明该属性，MongoDB会自动产生一个 ObjectId 类型的＿id 属性。insert()方法会在执行后返回＿id值。
print(result) 	# 932a68615c2606814c91f3d
```

### 查询数据

查询数据方法：

```python
# find：查询出来的是一个列表集合
# 查询所有数据
cursor = coll.find()
# 查询字段是最上层的
cursor = coll.find({“borough”: “Manhattan”})
# 查询字段在内层嵌套中
cursor = coll.find({“address.zipcode”: “10075”})

# find_one：查找一条数据，返回的是一个JSON式文档，所以可以直接使用！
```

查询操作：

```python
# 查询得分大于30的数据
cursor = coll.find({“grades.score”: {“$gt”: 30}})
# 查询得分小于10的数据
cursor = coll.find({“grades.score”: {“$lt”: 10}})
# and条件查询，find() 方法可以传入多个键(key)，每个键(key)以逗号隔开，即常规 SQL 的 AND 条件。
cursor = coll.find({“cuisine”: “Italian”, “address.zipcode”: “10075”})
# or条件查询
cursor = coll.find({“$or”: [{“cuisine”: “Italian”}, {“address.zipcode”: “10075”}]})

# sort排序使用的列表，当排序的标准只有一个，且是递增时，可以直接写在函数参数中：
# 升序
pymongo.ASCENDING = 1
# 升序排列
cursor = coll.find().sort(“borough”)
# 降序
pymongo.DESCENDING = -1
# 降序排列
cursor = coll.find().sort([(“borough”, pymongo.ASCENDING),(“address.zipcode”, pymongo.DESCENDING)])
```

### 修改数据

修改方法：

```python
# 更新⽂档的函数有三个(不能更新_id字段)
# 更新匹配的第一条数据
update_one(filter, update, upsert=False)
# 更新匹配的每一条数据
update_many(filter, update, upsert=False)
# 替换匹配的第一条数据
replace_one(filter, replacement, upsert=False)
# 查找并更新匹配的第一条数据
find_one_and_update(filter, update, projection=None, sort=None, 
return_document=ReturnDocument.BEFORE, **kwargs)
```

更新操作：

```python
# update_one：返回结果是⼀个UpdateResult ，如果查找到多个匹配，则只更新第⼀个！
'''
result = coll.update_one(
 {“name”: “Juni”},
 {
 “$set”: {
 “cuisine”: “American (New)”
 },
 “$currentDate”: {“lastModified”: True}
 }
)
'''

# update_many：查找到多少匹配，就更新多少。
'''
result = coll.update_many(
 {“address.zipcode”: “10016”, “cuisine”: “Other”},
 {
 “$set”: {“cuisine”: “Category To Be Determined”},
 “$currentDate”: {“lastModified”: True}
 }
)
'''
```

### 删除数据

```python
# 删除⼀个
result = coll.delete_one({‘x’: 1})
# 删除多个
result = coll.delete_many({“borough”: “Manhattan”})
# 删除全部
result = coll.delete_many({})
# 删除整个集合，是drop_collection()的别名
coll.drop()
```

### motor

motor使用MongoDB存储的异步库：

```python
import motor.motor_asyncio

# 连接MongoDB数据库
client = motor.motor_asyncio.AsyncIOMotorClient('mongodb://localhost:27017')

db = client['test_database']
collection = db['test_collection']

async def do_insert():
   document = {'key': 'value'}
   result = await db.test_collection.insert_one(document)
   print('result %s' % repr(result.inserted_id))

async def do_find_one():
   document = await db.test_collection.find_one({'i': {'$lt': 1}})
   pprint.pprint(document)
```

## SSH链接

以往我们访问数据库的方式都是直连的，也就是直接访问数据库。**但在项目当中，处于安全的考虑，很多情况下线上的数据库都不允许直接访问，大多是通过SSH链接访问。**例如：数据库在A机器，但只能通过B机器来访问，C机器想要访问A机器的数据库，就只能链接B机器再链接A机器访问数据库了。

### SSH简介

SSH 为 Secure Shell 的缩写，由 IETF 的网络小组（Network Working Group）所制定；SSH 为建立在应用层基础上的安全协议。SSH 是较可靠，专为远程登录会话和其他网络服务提供安全性的协议。利用 SSH 协议可以有效防止远程管理过程中的信息泄露问题。

### 链接线上

在Python中可以使用 `mysqldb` 模块通过ssh隧道来链接线上的MySQL数据库：

```python
import pymysql
import yagmail
from sshtunnel import SSHTunnelForwarder

class Spider_Mail(object):
    def __init__(self):
        self.server = None
        self.db = None
        self.cursor = None

    def connect_mysql(self):
        try:
            # 链接到SSH主机上
            self.server = SSHTunnelForwarder(
                ('0.0.0.0', 22),  # SSH主机的IP地址和开放端口
                ssh_username="username",  # SSH的链接的用户名
                ssh_password="password",  # SSH的链接的密码
                remote_bind_address=('0.0.0.0', 3306))  # 数据库所在的IP和端口
            self.server.start()
            # 选择要连接的数据库
            self.db = pymysql.connect(host="127.0.0.1",  # 固定写法
                                 port=self.server.local_bind_port,
                                 user="user",  # 数据库账号
                                 passwd="passwd",  # 数据库密码
                                 db="database")  # 访问特定的数据库
            self.cursor = self.db.cursor()
            print('-'*40+'连接线上数据库成功'+'-'*40)
        except Exception as e:
            print(f'连接线上数据库出错：{e}')

    def main(self):
        self.connect_mysql()
        if self.server and self.db and self.cursor:
            try:
                # 这里执行数据库里面的一些操作
                # 关闭连接
                self.db.close()
                self.server.close()
                print('-' * 40 + '关闭线上数据库连接' + '-' * 40)
            except Exception as e:
                print(f'程序出错：{e}')
```

