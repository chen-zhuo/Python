# 单例模式

### 定义

单例模式，是一种常用的软件设计模式。

我们都知道一个类可以创建无数个实例对象。**单例模式就是指一个类只能有一个实例，即一个类的实例从始至终只能被创建一次。**

### 单例模式

写单例模式我们要先要理解一些方法

##### \__init__方法

​	\__init__方法作用：初始化，用来**初始化（不参与创造对象）**新创建的对象，在一个对象创建以后被会立即调用。

```
# 创建People这个类
class People:
	
	# self代表通过类创建的对象
    def __init__(self, age, sex):
        self.age = age
        self.sex = sex
        print('实例人物已构造')

# 这里使用People这个类创建chen对象时，就会立即执行People类里面的__init__方法，通过将括号里的（18,'男'）实参传递给__init__方法里的(age,sex)形参，来实例化chen这个对象
chen = People(18, '男')

# 实例化后，就能使用这个实例的属性
print(chen.age)
print(chen.sex)

结果：
实例人物已构造
18
男
```

理解下面例子

```
# 创建一个地球类
class Earth:
    def __init__(self):
        print('执行init')

a = Earth()
print(a)

结果：
执行init
<__main__.Earth object at 0x000000AF9A0884E0>
```

​	这里通过Earth这个类创建了a这个实例对象，并且执行了\__init__函数，打印了（’执行init‘），print(a)则打印实例对象，其结果为：Earth object（Earth的对象），确认a是通过Earth类创建的。

##### \__new__方法

\__new__方法作用：新建并返回对象

```
class Earth:
    def __init__(self):
        print('执行init')
	
	# 重新定义__new__方法
	# cls相当与__init__方法中的self，类对象
    def __new__(cls):
        print('执行new')


a = Earth()
print(a)

结果：
执行new
None
```

​	这里我们可以看出结果与上面的例子有很大不同。通过结果可知道最先执行了\__new__方法，print(a)打印结果为：None（空），说明这个对象为空，对象不存在。

​	其原因就是：**\_\_new\_\_方法原本功能是创建和返回对象，而在程序中我们重新定义了该方法，只打印了一句字符串，既没有创建对象，也没返回对象，也就无法执行\_\_init\_\_方法来初始化对象来执行下面的打印语句。对象都没有创建，所以print(a)为None。**那为什么上面的例子没写\_\_new\_\_方法就能创建对象？**这是因为\_\_new\_\_方法【在未被重新定义时】默认使用Object类里面的\_\_new\_\_方法，该类方法就能创建和返回对象**

```
class Earth:
    def __init__(self):
        print('执行init')

    def __new__(cls):
        print('执行new')
        # 返回通过object类的__new__方法创建的对象
        return object.__new__(cls)


a = Earth()
print(a)

结果：
执行new
执行init
<__main__.Earth object at 0x0000000D599C8978>
```

​	这里我们可以看的很明白，首先执行了\_\_new\_\_方法，接着执行了_\_init\_\_方法，最后打印实例对象a。和上面的例子比就多了一行代码。**在\_\_new\_\_方法里执行了默认object类的\_\_new\_\_方法，即object.\_\_new__(cls)，创建了对象，并且通过return返回了对象，注意这里的对象必须返回，如果没有return，则这个例子的结果和上个例子的结果相同。**

##### \__instance私有属性

**__代表私有（私有：在外部不能直接使用,可以在类的内部使用）**，instance代表属性名称

```
class Earth:
    __instance = None
    print(__instance)
    
    def __new__(cls):
        print(cls.__instance)
        # 这里改变了类对象的私有属性
        cls.__instance = True

a = Earth()

结果：
None
None
```

​	在Earth类里面定义了一个__instance私有属性，打印了这个私有属性，又在\_\_new\_\_方法里再次打印了这个私有属性，结果都为None。

```
class Earth:
    __instance = None  # 1
    print(__instance)  # 2

    def __new__(cls):  # 3
        print(cls.__instance)
        cls.__instance = True


a = Earth()  # 4
b = Earth()  # 5

结果：
None
None
True
```

这里结果又不一样了。这里就要一步一步说程序流程了：

1. 程序开始运行

2. 执行Earth里面的1、2

3. 打印__instance结果为None

4. 执行4（创建a对象）

5. 执行Earth里面的3（1，2不执行），首次在3中打印\_\_instance结果为None，并且改变了类对象\_\_instance值为True

6. 执行执行5（创建b对象）

7. 执行Earth里面的3（1，2不执行），第二次在3中打印\_\_instance结果为True

**说明在创建a对象时，改变了类方法里面的私有属性\_\_instance的值，创建b对象时，会沿用私有属性_\_instance被改变的值。**

##### 简单单例模式

运用上面的的方法和属性我们可以来写一个单例模式

```
class Earth:
    __instance = None

    def __new__(cls):
    	# 如果__instance为空，说明是第一次执行
        if cls.__instance == None:
        	
        	# 执行object.__new__(cls)，建立对象
            cls.__instance = object.__new__(cls)
            # 返回新建对象
            return cls.__instance
        
        # 如果__instance不为空，说明对象存在直接返回
        return cls.__instance


a = Earth()
print(id(a))
b = Earth()
print(id(b))

结果：
846411303120
846411303120
# id相同，说明a、b是同一对象。
```

##### 进阶单例模式

我们向单例模式传递参数

```
class Earth:
    __instance = None

	# 定义__init__方法，name形参接收实参
    def __init__(self, name):
        self.name = name

	# 多传了姓名参数，这里也要添加name形参
    def __new__(cls, name):
        if cls.__instance == None:
            cls.__instance = object.__new__(cls)
            return cls.__instance
        return cls.__instance


a = Earth('地球')
print(a.name, id(a))
b = Earth('火星')
print(b.name, id(b))
print(a.name, id(a))

结果：
地球 53131512912
火星 53131512912
火星 53131512912
# 根据id说明，对象只有一个。但是第一次打印a.name结果为‘地球’，没问题，当创建完b对象后，第二次打印a.name结果为‘火星’，说明a对象属性被b对象属性覆盖了。
```

为了不该属性，我们就得再添加一个私有属性做判断

```
class Earth:
    __instance = None
    # 新增__first属性
    __first = False

    def __init__(self, name):
    	# 如果__first为False，说明是第一次初始化
        if self.__first == False:
            self.name = name
            self.__first = True

    def __new__(cls, name):
        if cls.__instance == None:
            cls.__instance = object.__new__(cls)
            return cls.__instance
        return cls.__instance


a = Earth('地球')
print(a.name, id(a))
b = Earth('火星')
print(b.name, id(b))
print(a.name, id(a))

结果：
地球 114167941496
地球 114167941496
地球 114167941496
# 从相同结果说明该对象属性未变动
```

##### 终极单例模式（了解）

这里的单例模式我们可以传任意参数

```
class Earth:
    __instance = None
    __first = False
	
	# *args不定参数，**kwargs针对字典类型不定参数字典
    def __init__(self, *args, **kwargs):
        if self.__first == False:
            self.args = args
            self.kwargs = kwargs
            self.__first = True

    def __new__(cls, *args, **kwargs):
        if cls.__instance == None:
            cls.__instance = object.__new__(cls)
            return cls.__instance
        return cls.__instance


a = Earth(name='陈')
b = Earth(1, 2, 3, 4)
c = Earth('地球')

print(a.kwargs['name'])
print(b.args)
print(c)

结果：
陈
()
<__main__.Earth object at 0x00000001020E8A58>
```
