# Echarts图表

## 简介

### 概况

Echarts 是一个由百度开源的数据可视化，凭借着良好的交互性，精巧的图表设计，得到了众多开发者的认可。而 Python 是一门富有表达力的语言，很适合用于数据处理。当数据分析遇上数据可视化时，pyecharts 诞生了。

### 特性

- 简洁的 API 设计，使用如丝滑般流畅，支持链式调用
- 囊括了 30+ 种常见图表，应有尽有
- 支持主流 Notebook 环境，Jupyter Notebook 和 JupyterLab
- 可轻松集成至 Flask，Django 等主流 Web 框架
- 高度灵活的配置项，可轻松搭配出精美的图表
- 详细的文档和示例，帮助开发者更快的上手项目
- 多达 400+ 地图文件以及原生的百度地图，为地理数据可视化提供强有力的支持

<img src="image/52348737-01fb8a80-2a60-11e9-94ac-dacbd7b58811.png" alt="52348737-01fb8a80-2a60-11e9-94ac-dacbd7b58811" style="zoom:33%;" />

<img src="image/52332988-0b243180-2a37-11e9-9db8-eb6b8c86a0de.png" alt="52332988-0b243180-2a37-11e9-9db8-eb6b8c86a0de" style="zoom:33%;" />

<img src="image/35089737-ccc1c01c-fc72-11e7-874d-8ba8b89572eb.png" alt="35089737-ccc1c01c-fc72-11e7-874d-8ba8b89572eb" style="zoom:33%;" />

<img src="image/52348202-bb596080-2a5e-11e9-84a7-60732be0743a.gif" alt="52348202-bb596080-2a5e-11e9-84a7-60732be0743a" style="zoom:33%;" />

<img src="image/35090457-afc0658e-fc74-11e7-9c58-24c780436287.gif" alt="35090457-afc0658e-fc74-11e7-9c58-24c780436287" style="zoom:33%;" />

<img src="image/57567164-bdd5a880-7407-11e9-8d19-9be2776c57fa.png" alt="57567164-bdd5a880-7407-11e9-8d19-9be2776c57fa" style="zoom:20%;" />

<img src="image/52727805-f7f20280-2ff0-11e9-91ab-cd99848e3127.gif" alt="52727805-f7f20280-2ff0-11e9-91ab-cd99848e3127" style="zoom:33%;" />

<img src="image/52346064-b7770f80-2a59-11e9-9e03-6dae3a8c637d.gif" alt="52346064-b7770f80-2a59-11e9-9e03-6dae3a8c637d" style="zoom:33%;" />

<img src="image/35089737-ccc1c01c-fc72-11e7-874d-8ba8b89572ea.png" alt="35089737-ccc1c01c-fc72-11e7-874d-8ba8b89572ea" style="zoom:50%;" />

<img src="image/52535013-e48e2f80-2d83-11e9-8886-ac0d2122d6af.png" alt="52535013-e48e2f80-2d83-11e9-8886-ac0d2122d6af" style="zoom:33%;" />

<img src="image/52197440-843a5200-289a-11e9-8601-3ce8d945b04a.gif" alt="52197440-843a5200-289a-11e9-8601-3ce8d945b04a" style="zoom:33%;" />

<img src="image/56976071-b9f28c80-6ba4-11e9-8efd-603203c77619.png" alt="56976071-b9f28c80-6ba4-11e9-8efd-603203c77619" style="zoom:33%;" />

<img src="image/35082279-e111743c-fc53-11e7-9362-580160593715.gif" alt="35082279-e111743c-fc53-11e7-9362-580160593715" style="zoom:33%;" />

<img src="image/52345490-4a16af00-2a58-11e9-9b43-7bbc86aa05b6.gif" alt="52345490-4a16af00-2a58-11e9-9b43-7bbc86aa05b6" style="zoom:33%;" />

<img src="image/52345115-6534ef00-2a57-11e9-80cd-9cbfed252139.gif" alt="52345115-6534ef00-2a57-11e9-80cd-9cbfed252139" style="zoom:33%;" />

<img src="image/52347915-0a52c600-2a5e-11e9-8039-41268238576c.gif" alt="52347915-0a52c600-2a5e-11e9-8039-41268238576c" style="zoom:33%;" />

<img src="image/52433989-4f075b80-2b49-11e9-9979-ef32c2d17c96.gif" alt="52433989-4f075b80-2b49-11e9-9979-ef32c2d17c96" style="zoom:33%;" />

<img src="image/52464826-4baab900-2bb7-11e9-8299-776f5ee43670.gif" alt="52464826-4baab900-2bb7-11e9-8299-776f5ee43670" style="zoom:33%;" />

<img src="image/52464647-aee81b80-2bb6-11e9-864e-c544392e523a.gif" alt="52464647-aee81b80-2bb6-11e9-864e-c544392e523a" style="zoom:33%;" />

<img src="image/52533994-932b7380-2d76-11e9-93b4-0de3132eb941.gif" alt="52533994-932b7380-2d76-11e9-93b4-0de3132eb941" style="zoom:33%;" />

<img src="image/52802261-8d0cfe00-30ba-11e9-8ae7-ae0773770a59.gif" alt="52802261-8d0cfe00-30ba-11e9-8ae7-ae0773770a59" style="zoom:33%;" />

<img src="image/35082251-b9e23982-fc53-11e7-8341-e7da1842389f.gif" alt="35082251-b9e23982-fc53-11e7-8341-e7da1842389f" style="zoom:30%;" />

<img src="image/57545910-431c7700-738e-11e9-896b-e071b55115c7.png" alt="57545910-431c7700-738e-11e9-896b-e071b55115c7" style="zoom:33%;" />

<img src="image/35082102-fd8d884a-fc52-11e7-9e40-5f94098d4493.gif" alt="35082102-fd8d884a-fc52-11e7-9e40-5f94098d4493" style="zoom:32%;" />

## 快速上手

### 下载安装

#### pip 安装

```shell
$ pip(3) install pyecharts
```

#### 源码安装

```shell
$ git clone https://github.com/pyecharts/pyecharts.git
$ cd pyecharts
$ pip install -r requirements.txt
$ python setup.py install
# 或者执行 python install.py
```

### 第一个图表

```python
# 导入柱状图
from pyecharts.charts import Bar
# 在pyecharts一切配置皆在options中
from pyecharts import options

# 写法一：pyecharts常见写法
bar = Bar(init_opts=options.InitOpts(width="900px", height="500px"))
bar.add_xaxis(["衬衫", "羊毛衫", "雪纺衫", "裤子", "高跟鞋", "袜子"])
bar.add_yaxis("商家A", [5, 20, 36, 10, 75, 90])
bar.set_global_opts(title_opts=options.TitleOpts(title="主标题", subtitle="副标题"))

# 写法二：pyecharts所有方法均支持链式调用
bar = (
    Bar(init_opts={"width": "900px", "height": "500px"})
    .add_xaxis(["衬衫", "羊毛衫", "雪纺衫", "裤子", "高跟鞋", "袜子"])
    .add_yaxis("商家A", [5, 20, 36, 10, 75, 90])
    .set_global_opts(title_opts={"text": "主标题", "subtext": "副标题"})
)

# 默认在当前目录生成render.html文件，也可以传入路径参数，如bar.render("mycharts.html")
bar.render()
```

?> Note: 在使用 Pandas&Numpy 时，请确保将数值类型转换为 python 原生的 int/float。比如整数类型请确保为 int，而不是 numpy.int32

![55601443-85510800-5793-11e9-8479-26ff27cdec7e](image/55601443-85510800-5793-11e9-8479-26ff27cdec7e.png)

### 主题风格

pyecharts 内置提供了 10+ 种不同的风格，另外也提供了便捷的定制主题的方法。

```python
# 导入柱状图
from pyecharts.charts import Bar
# 导入主题
from pyecharts.globals import ThemeType

Bar(init_opts=opts.InitOpts(theme=ThemeType.WHITE)) # 默认主题，等价于Bar()
Bar(init_opts=opts.InitOpts(theme=ThemeType.LIGHT))
Bar(init_opts=opts.InitOpts(theme=ThemeType.DARK))
Bar(init_opts=opts.InitOpts(theme=ThemeType.CHALK))
Bar(init_opts=opts.InitOpts(theme=ThemeType.ESSOS))
Bar(init_opts=opts.InitOpts(theme=ThemeType.INFOGRAPHIC))
Bar(init_opts=opts.InitOpts(theme=ThemeType.MACARONS))
Bar(init_opts=opts.InitOpts(theme=ThemeType.PURPLE_PASSION))
Bar(init_opts=opts.InitOpts(theme=ThemeType.ROMA))
Bar(init_opts=opts.InitOpts(theme=ThemeType.ROMANTIC))
Bar(init_opts=opts.InitOpts(theme=ThemeType.SHINE))
Bar(init_opts=opts.InitOpts(theme=ThemeType.VINTAGE))
Bar(init_opts=opts.InitOpts(theme=ThemeType.WALDEN))
Bar(init_opts=opts.InitOpts(theme=ThemeType.WESTEROS))
Bar(init_opts=opts.InitOpts(theme=ThemeType.WONDERLAND))
```

<img src="image/55897058-5bb03a80-5bf2-11e9-9ab8-7d6b5419b68b.png" alt="55897058-5bb03a80-5bf2-11e9-9ab8-7d6b5419b68b" style="zoom:33%;" />

<img src="image/55897092-6cf94700-5bf2-11e9-8fa9-e7d880481a90.png" alt="55897092-6cf94700-5bf2-11e9-8fa9-e7d880481a90" style="zoom:33%;" />

<img src="image/55897130-80a4ad80-5bf2-11e9-836d-748b15b260ce.png" alt="55897130-80a4ad80-5bf2-11e9-836d-748b15b260ce" style="zoom:33%;" />

<img src="image/55897251-bd70a480-5bf2-11e9-805e-6c0bd5e76b48.png" alt="55897251-bd70a480-5bf2-11e9-805e-6c0bd5e76b48" style="zoom:33%;" />

<img src="image/55897288-cfeade00-5bf2-11e9-8b45-1f8aa45a166b.png" alt="55897288-cfeade00-5bf2-11e9-8b45-1f8aa45a166b" style="zoom:33%;" />

<img src="image/55897310-dc6f3680-5bf2-11e9-921a-cc8981570378.png" alt="55897310-dc6f3680-5bf2-11e9-921a-cc8981570378" style="zoom:33%;" />

<img src="image/55897352-ef820680-5bf2-11e9-8d4f-314c2abb40df.png" alt="55897352-ef820680-5bf2-11e9-8d4f-314c2abb40df" style="zoom:33%;" />

<img src="image/55897399-ff99e600-5bf2-11e9-9135-0a186f0acad5.png" alt="55897399-ff99e600-5bf2-11e9-9135-0a186f0acad5" style="zoom:33%;" />

<img src="image/55897419-0d4f6b80-5bf3-11e9-8314-f433ab1cca5c.png" alt="55897419-0d4f6b80-5bf3-11e9-8314-f433ab1cca5c" style="zoom:33%;" />

<img src="image/55897475-2821e000-5bf3-11e9-9079-e8a6458900b2.png" alt="55897475-2821e000-5bf3-11e9-9079-e8a6458900b2" style="zoom:33%;" />

<img src="image/55897502-366ffc00-5bf3-11e9-8492-ca9e162dafac.png" alt="55897502-366ffc00-5bf3-11e9-8492-ca9e162dafac" style="zoom:33%;" />

<img src="image/55897530-47b90880-5bf3-11e9-89d8-5466f0f7f3b1.png" alt="55897530-47b90880-5bf3-11e9-89d8-5466f0f7f3b1" style="zoom:33%;" />

<img src="image/55897553-556e8e00-5bf3-11e9-8146-67c3e4d30109.png" alt="55897553-556e8e00-5bf3-11e9-8146-67c3e4d30109" style="zoom:33%;" />

<img src="image/55897595-6a4b2180-5bf3-11e9-97b1-61b9c575af9e.png" alt="55897595-6a4b2180-5bf3-11e9-97b1-61b9c575af9e" style="zoom:33%;" />

<img src="image/55897678-8bac0d80-5bf3-11e9-9ca4-a85b3868cf81.png" alt="55897678-8bac0d80-5bf3-11e9-9ca4-a85b3868cf81" style="zoom:33%;" />

### 图表案例

```python
#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Time    : 2021/11/5
# @Author  : chenzhuo
# @Desc    : 统计爬虫采集的数据量
import os
import time
import openpyxl
import datetime
import requests
import paramiko
from pyecharts.charts import Line
from pyecharts import options as opts
from pyecharts.globals import ThemeType


class Echarts(object):

    def __init__(self):
        self.route = 'E:\Desktop\资质安许历史'
        # 初始话
        self.qca_data = {}
        self.safe_data = {}
        self.company_data = {}
        # 处理后
        self.etl_qca_data = {}
        self.etl_safe_data = {}
        self.etl_company_data = {}
        # 工商数据接口
        self.link = 'http://47.103.21.215:8008/data_status'
        # 时间范围
        self.history_date = []
        # 215服务器
        self.linux_server = '47.103.21.215'

    def read_excel(self):
        '''
        读取所有资质安许excel表
        :return:
        '''
        # 读取最后30个文件
        file_list = os.listdir(self.route)[-40:]
        for file in file_list:
            # 表格日期
            excel_date = file.replace('资质安许.xlsx', '')
            # 导入字典
            self.qca_data.update({excel_date:{}})
            self.safe_data.update({excel_date:{}})
            # 读取excel表格
            wb = openpyxl.load_workbook(self.route+'\\'+file)
            # 选定需要读取的工作薄
            ws = wb['Sheet1']
            # 字段
            filed = '资质'
            # ws.max_row最大行，ws.max_column最大列
            for row in range(3, ws.max_row + 1):
                if ws.cell(row=row, column=1).value == '安许':
                    filed = '安许'
                    continue
                area = ws.cell(row=row, column=2).value[:2]
                if filed == '资质':
                    self.qca_data.get(excel_date).update(
                        {
                            area:
                                {
                                    'qca_area_level':ws.cell(row=row, column=1).value,
                                    'qca_count': ws.cell(row=row, column=3).value,
                                    'qca_update_time': str(ws.cell(row=row, column=4).value)[5:10],
                                }
                        }
                    )
                else:
                    self.safe_data.get(excel_date).update(
                        {
                            area:
                                {
                                    'safe_area_level': ws.cell(row=row, column=1).value,
                                    'safe_count': ws.cell(row=row, column=3).value,
                                    'safe_update_time': str(ws.cell(row=row, column=4).value)[5:10],
                                }
                        }
                    )

    def get_company_data(self):
        '''
        获取工商数据
        :return:
        '''
        response = requests.get(self.link).json()
        data = response.get("data").get("CompanyData")
        for item in data:
            mouth = data.get(item).get('version')[4:6]
            day = data.get(item).get('version')[6:]
            date = mouth + '-' +day
            count = data.get(item).get('data_num')
            self.company_data.update(
                {date: count}
            )

    def row_date(self, num):
        '''
        时间范围和地区初始空列表
        :return:
        '''
        now_dt = datetime.datetime.now()
        for day in range(-num+1, 1):
            history_date = now_dt + datetime.timedelta(days=day)
            self.history_date.append(str(history_date)[5:10])

        self.etl_qca_data = {'江苏':[None]*num, '四川':[None]*num, '广西':[None]*num, '湖北':[None]*num,
                            '湖南':[None]*num, '河南':[None]*num, '云南':[None]*num, '广东':[None]*num, '浙江':[None]*num,
                            '重庆':[None]*num, '安徽':[None]*num, '山东':[None]*num}
        self.etl_safe_data = {'江苏':[None]*num, '四川':[None]*num, '广西':[None]*num, '湖北':[None]*num,
                          '湖南':[None]*num, '河南':[None]*num,'云南':[None]*num, '广东':[None]*num, '浙江':[None]*num,
                          '重庆':[None]*num, '安徽':[None]*num, '山东':[None]*num}
        self.etl_company_data = {'工商':[None]*num}

    def etl_data(self):
        '''
        数据处理成图表数据
        :return:
        '''
        # 遍历资质数据
        for qca_name in self.qca_data:
            for area in self.etl_qca_data:
                try:
                    qca_count = self.qca_data.get(qca_name).get(area).get('qca_count')
                    qca_update_time = self.qca_data.get(qca_name).get(area).get('qca_update_time')
                    if qca_update_time in self.history_date:
                        index = self.history_date.index(qca_update_time)
                        self.etl_qca_data.get(area)[index] = qca_count
                except:
                    print(f'{qca_name},{area}资质数据为空')
        # 遍历安许数据
        for safe_name in self.safe_data:
            for area in self.etl_safe_data:
                try:
                    safe_count = self.safe_data.get(safe_name).get(area).get('safe_count')
                    safe_update_time = self.safe_data.get(safe_name).get(area).get('safe_update_time')
                    if safe_update_time in self.history_date:
                        index = self.history_date.index(safe_update_time)
                        self.etl_safe_data.get(area)[index] = safe_count
                except:
                    print(f'{safe_name},{area}安许数据为空')
        # 遍历工商数据
        for com_data in self.company_data:
            try:
                index = self.history_date.index(com_data)
                self.etl_company_data.get('工商')[index] = self.company_data.get(com_data)
            except:
                print(f'工商接口数据大于30天：{com_data}')

    def paint_chart(self, num):
        all_chart = {
            '资质': [self.etl_qca_data, 'zizhi_chart.html', '资质抓取数据（公司数量）'],
            '安许': [self.etl_safe_data, 'anxu_chart.html', '安许抓取数据（公司数量）'],
            '工商': [self.etl_company_data, 'gongshang_chart.html', '工商加载数据（加载数量）']
        }
        for chart_type in all_chart:
            # 图表类
            chart_line = Line(init_opts={'width': '1900px', 'height': '900px', 'theme': ThemeType.CHALK})
            # 资质图表
            chart_line.page_title = f'{chart_type}图表'
            # 横坐标日期
            chart_line.add_xaxis(self.history_date)
            # 纵坐标地区和数量
            etl_data = all_chart.get(chart_type)[0]
            for area in etl_data:
                chart_line.add_yaxis(area, etl_data.get(area), is_connect_nones=True, is_selected=False)
            chart_line.set_global_opts(
                title_opts=opts.TitleOpts(title=f"{all_chart.get(chart_type)[2]}", subtitle=f"时间范围{num}天"),
                toolbox_opts = opts.ToolboxOpts(is_show=True,
                pos_top="top",
                pos_left="right",
                feature={"saveAsImage": {},
                      "restore": {},
                      "magicType": {"show": True, "type": ["line", "bar"]},
                      "dataView": {}}))
            chart_line.render(f"chart/{all_chart.get(chart_type)[1]}")

    def update_chart(self):
        # 上传html文件
        windows_command = (
            'scp D:/chenzhuo/longna_distributed_reboot/test/chart/home_chart.html root@47.103.21.215:/home/py_saas/longna_saas_app/app/templates/admin/',
            'scp D:/chenzhuo/longna_distributed_reboot/test/chart/zizhi_chart.html root@47.103.21.215:/home/py_saas/longna_saas_app/app/templates/admin/',
            'scp D:/chenzhuo/longna_distributed_reboot/test/chart/anxu_chart.html root@47.103.21.215:/home/py_saas/longna_saas_app/app/templates/admin/',
            'scp D:/chenzhuo/longna_distributed_reboot/test/chart/gongshang_chart.html root@47.103.21.215:/home/py_saas/longna_saas_app/app/templates/admin/'
        )
        # 命令流重启flask服务
        linux_command = (
            # 进入flask会话
            "tmux a -t flask\n",
            # 暂停服务（作用等于Ctrl+C）
            "\x03\n",
            # 再启动flask服务
            "python /home/py_saas/longna_saas_app/manage.py\n"
        )
        try:
            # 上传文件
            for com in windows_command:
                print(os.system(com))  # 将结果赋值给变量
                time.sleep(3)
            # 重启服务
            ssh = paramiko.SSHClient()
            ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            ssh.connect(self.linux_server, port=22, username='root', key_filename='C:/Users/yy/.ssh/id_rsa')
            chan = ssh.invoke_shell()  # 新函数
            for com in linux_command:
                chan.send(com)
                # 暂停一段时间，等待命令响应
                time.sleep(5)
                res = chan.recv(20000)  # 非必须，接受返回消息
                print(res.decode())
            ssh.close()
        except Exception as e:
            print(e)

    def run(self):
        # 设置时间范围为30天
        self.date_length = 30
        # 获取表格数据
        chart.read_excel()
        # 获取工商数据
        chart.get_company_data()
        # 时间范围和地区初始空列表
        chart.row_date(self.date_length)
        # 处理成
        chart.etl_data()
        # 生成图表
        chart.paint_chart(self.date_length)
        # 更新图表
        chart.update_chart()
        print('所有图表已更新')

if __name__ == '__main__':
    chart = Echarts()
    chart.run()
```

![QQ截图20211113180159](image/QQ截图20211113180159.png)

